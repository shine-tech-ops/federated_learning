<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Federated Learning Assistant</title>
    <script>window.injectInfo = {env: "PROD"};</script>
    <script>window.publicPath = "./static";</script>
    <script>window.platform = "android";</script>
    <script data-logging-script="true" src="./static/mini-app-log.js"></script>

    <script defer="" src="./static/mini-app-base.js"></script>
    <script defer="" src="./static/tailwind4.1.13.js"></script>
    <link href="./static/material-icons.css" rel="stylesheet">
    <link href="./static/tailwindcss.css" rel="stylesheet">
    <link href="./static/custom.css" rel="stylesheet">
    <script src="./static/axios.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/lib/marked.umd.js"></script>
</head>
<body style="margin: 0 !important; padding: 0 !important; display: flex !important; align-items: center !important; justify-content: center !important;">
<div class="container p-4 w-full" id="container" style="margin: 0 !important; padding-top: 6.5rem !important;">

    <!-- 设置 -->
    <div id="settings" class="card fixed background-white hidden">
        <h2>Settings</h2>
        <div class="group">
            <div class="item">
                <span>Ollama Host:</span>
                <label>
                    <input name="ollamaHost" placeholder="Please input ollama host" />
                </label>
                <span class="text-gray-400">Warn: Need to start on mobile terminal.</span>
            </div>
            <div class="item">
                <span>Server Host:</span>
                <label>
                    <input name="serverHost" placeholder="Please input server host" />
                </label>
            </div>
            <div class="item">
                <span>Server UserName:</span>
                <label>
                    <input name="serverUserName" placeholder="Please input server username" />
                </label>
            </div>
            <div class="item">
                <span>Server Password:</span>
                <label>
                    <input name="serverPassword" type="password" placeholder="Please input server password" />
                </label>
            </div>
        </div>
        <div class="actions">
            <button class="btn-back">Back</button>
            <button class="btn-save">Save</button>
        </div>
    </div>

    <!-- 头部状态栏 -->
    <div class="mb-6" id="status-bar">
        <h1 class="text-2xl font-bold text-gray-800 mb-2">Federated Learning Assistant</h1>
        <div class="flex items-center justify-between text-sm text-gray-600">
            <div class="flex items-center justify-center">
                <span class="status-indicator status-idle" id="connectionStatus"></span>
                <span id="connectionText" style="margin-right: 12px;">Device disconnected</span>
            </div>
            <div class="flex items-center justify-center" id="openTerminal" onclick="openTerminal()">
                <span class="material-icons text-blue-500 mr-1" style="font-size: 20px">terminal</span>
                <span class="text-blue-500" style="margin-right: 12px;">Open terminal</span>
            </div>
        </div>
    </div>

    <!-- 下载模型 -->
    <div class="mt-4 mb-4 hidden" id="downloadModelList">
        <h2 class="text-lg font-semibold text-gray-800 mb-4">Sync models</h2>
        <div class="grid grid-cols-3 gap-3" id="downloadModelListContainer">
        </div>
        <div class="text-sm mt-2 text-gray-400">Tip: Click on the model card to synchronize the model</div>

        <div id="sync-model-version-modal" class="card fixed p-4 hidden">
            <h2 class="mb-4">Model version lists</h2>
            <span class="material-icons text-sm absolute close" style="top: 12px; right: 12px;">close</span>
            <div class="group"></div>
        </div>
    </div>

    <!-- 模型选择区域 -->
    <div class="mb-6" id="modelSelector">
        <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">Function Selection</h2>
            <div class="flex items-center mb-4" style="color: orange;" id="eventSettings">
                <span class="material-icons" style="font-size: 18px;">settings</span>
                <span style="margin-left: 4px; font-size: 16px;">Settings</span>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
            <div class="model-card rounded-lg p-3 text-center active" data-testid="small-model-card"
                 id="smallModelCard">
                <span class="material-icons text-blue-500 mb-2">memory</span>
                <div class="text-sm font-medium text-gray-800">Train</div>
                <div class="text-xs text-gray-500 mt-1">Local model training</div>
            </div>
            <div class="model-card rounded-lg p-3 text-center" data-testid="large-model-card" id="largeModelCard">
                <span class="material-icons text-blue-500 mb-2">chat</span>
                <div class="text-sm font-medium text-gray-800">Chat</div>
                <div class="text-xs text-gray-500 mt-1">Cloud based Large Model Dialogue</div>
            </div>
        </div>

        <!-- 大模型列表 -->
        <div class="mt-4" id="largeModelList" style="display: none;">
            <h3 class="text-sm font-medium text-gray-700 mb-3">Select large models</h3>
            <div class="grid grid-cols-3 gap-3" id="modelListContainer">
                <!---->
            </div>
        </div>
    </div>

    <!-- 训练任务区域 -->
    <div id="trainingTask" class="mb-6" style="opacity: 1; transition: opacity 0.3s ease-in-out;">
        <h2 class="text-lg font-semibold text-gray-800 mb-4">Training task</h2>

        <!-- 当前任务详情 -->
        <div class="model-card rounded-lg p-4 mb-4 selected">
            <div class="flex items-center justify-between mb-3">
                <div>
                    <div class="font-medium text-gray-800" id="modelName">---</div>
                    <div class="text-sm text-gray-500" id="modelDescription">---</div>
                </div>
                <span class="status-indicator status-idle" id="taskStatus"></span>
            </div>

            <div class="mb-4">
                <div class="flex justify-between text-sm text-gray-600 mb-2">
                    <span>Training Progress</span>
                    <span id="progressText">-%</span>
                </div>
                <div class="progress-bar h-2">
                    <div class="progress-fill" id="progressFill" style="width: 0"></div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-2 text-sm">
                <div>
                    <span class="text-gray-500">Task ID:</span>
                    <span class="font-medium text-gray-800 ml-1" id="taskID">--</span>
                </div>
                <div>
                    <span class="text-gray-500">Task Name:</span>
                    <span class="font-medium text-gray-800 ml-1" id="taskName">--</span>
                </div>
                <div>
                    <span class="text-gray-500">Rounds:</span>
                    <span class="font-medium text-gray-800 ml-1" id="epochCount">-/-</span>
                </div>
                <div>
                    <span class="text-gray-500">Accuracy:</span>
                    <span class="font-medium text-gray-800 ml-1" id="accuracy">-</span>
                </div>
                <div>
                    <span class="text-gray-500">Correct:</span>
                    <span class="font-medium text-gray-800 ml-1" id="correct">-</span>
                </div>
                <div>
                    <span class="text-gray-500">Sample Count:</span>
                    <span class="font-medium text-gray-800 ml-1" id="sampleCount">-</span>
                </div>
                <div class="">
                    <span class="text-gray-500">Loss:</span>
                    <span class="font-medium text-gray-800 ml-1" id="loss">-</span>
                </div>
                <div class="col-span-2">
                    <span class="text-gray-500">Aggregation Method:</span>
                    <span class="font-medium text-gray-800 ml-1" id="aggregationMethod">-</span>
                </div>
            </div>
        </div>

<!--        <div class="space-y-2" id="taskList">-->
<!--            <div class="task-item" data-task-id="1" data-testid="task-item-1">-->
<!--                <div class="flex items-center justify-between">-->
<!--                    <div class="flex-1">-->
<!--                        <div class="font-medium text-sm text-gray-800">-&#45;&#45;</div>-->
<!--                        <div class="text-xs text-gray-500 mt-1">-&#45;&#45;</div>-->
<!--                    </div>-->
<!--                    <div class="text-right">-->
<!--                        <div class="text-xs text-blue-600 font-medium">&#45;&#45;</div>-->
<!--                        <div class="text-xs text-gray-400">-&#45;&#45;</div>-->
<!--                    </div>-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->
    </div>

    <!-- 对话区域 -->
    <div id="chatArea" class="mb-6 hidden">
        <h2 class="text-lg font-semibold text-gray-800 mb-4">Model Chat</h2>
        <div class="model-card rounded-lg p-4">
            <div class="bg-gray-50 rounded-lg p-3 h-72 overflow-y-auto mb-4" id="chatContainer">
                <div class="space-y-3" id="chatMessages">
                    <div class="flex justify-start">
                        <div class="chat-bubble bg-white border border-gray-200 rounded-lg p-3">
                            <div class="text-sm text-gray-800">Hello! I am the Federal Learning Assistant. May I help you with anything?</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex gap-2">
                <label class="relative" for="chatInput" style="width: 100%;">
                    <textarea
                        id="chatInput"
                        class="block relative input border border-2 p-2 border-gray-200 rounded-lg"
                        style="resize: none"
                        placeholder="Enter your question..."
                    ></textarea>
                    <label class="absolute flex file-btn" id="fileBtn" for="imageUpload">
                        <span class="material-icons">attach_file</span>
                    </label>
                    <button class="absolute flex save-btn" id="saveBtn">
                        <span class="material-icons">save</span>
                    </button>
                    <button class="absolute flex send-btn" id="sendBtn">
                        <span class="material-icons">arrow_upward</span>
                    </button>
                </label>

                <input
                    type="file"
                    id="imageUpload"
                    accept="image/*"
                    style="display: none;"
                    multiple
                >

                <!-- 保存对话历史弹窗 -->
                <div id="save-chat-history-modal" class="absolute fixed p-4 hidden">
                    <h2 class="mb-2">保存对话历史设置</h2>
                    <div class="item mb-2">
                        <span>模型ID</span>
                        <label>
                            <input type="text" style="padding: 3px 6px;" name="model_version" />
                        </label>
                    </div>
                    <div class="item mb-4">
                        <span>设备ID</span>
                        <label>
                            <input type="text" style="padding: 3px 6px;" name="edge_node" />
                        </label>
                    </div>
                    <div class="action flex justify-end">
                        <button class="cancel" id="save-cancel">取消</button>
                        <button class="finish" id="save-finish">确认</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="module" src="./static/app.js"></script>
<script type="text/javascript">
    // 打开终端
    function openTerminal() {
        if (typeof Android !== 'undefined') {
            Android.closeWindow();
        }
    }
    // 设置设备状态（Android Received）
    let reset_device_status_timeout = null;
    function onDeviceInfoReceived(device_info) {
        // 设置训练任务模型
        const setTrainTaskModel = ({ name, description }) => {
            document.getElementById('modelName').innerHTML = name;
            document.getElementById('modelDescription').innerHTML = description;
        }
        // 设置训练任务信息
        const setTrainTaskInfo = ({ id, name }) => {
            document.getElementById('taskID').innerHTML = id || '--';
            document.getElementById('taskName').innerHTML = name || '--';
        }
        // 设置训练任务参数
        const setTrainTaskArguments = (data) => {
            const { index, round, aggregation_method, progress, accuracy, loss, correct, total } = data;
            document.getElementById('progressText').innerHTML = progress + "%";
            document.getElementById('progressFill').style.width = progress + "%";
            document.getElementById('epochCount').innerHTML = (index || '--') + "/" + (round || '--');
            document.getElementById('aggregationMethod').innerHTML = aggregation_method || '--';
            document.getElementById('accuracy').innerHTML = accuracy || '--';
            document.getElementById('loss').innerHTML = loss || '--';
            document.getElementById('correct').innerHTML = correct || '--';
            document.getElementById('sampleCount').innerHTML = total || '--';

            const taskStatus = document.getElementById('taskStatus');
            if (taskStatus.classList.contains('status-idle')) {
                taskStatus.classList.remove('status-idle');
                taskStatus.classList.add('status-active');
            }
            if (progress > 0 && progress < 100) {
                if (taskStatus.classList.contains('status-active')) {
                    taskStatus.classList.remove('status-active');
                }
                if (!taskStatus.classList.contains('status-training')) {
                    taskStatus.classList.add('status-training');
                }
            }
        }

        try {
            // 如果传递的是字符串，需要解析
            if (typeof device_info === 'string') {
                device_info = JSON.parse(device_info);
            }
            // 处理数据...
            console.log('接收到的设备信息:', JSON.stringify(device_info));
            const { id, status, timestamp, description } = device_info['device'];
            console.log(timestamp);
            console.log(description);
            const connectionStatus = document.getElementById('connectionStatus');
            if (status === 'online') {
                clearTimeout(reset_device_status_timeout);
                if (connectionStatus.classList.contains('status-idle')) {
                    connectionStatus.classList.remove('status-idle');
                    connectionStatus.classList.add('status-active');
                }
                document.getElementById('connectionText').innerHTML = '' + id + ' online';
                // 设置训练任务模型
                setTrainTaskModel(device_info['model']);
                // 设置训练任务信息
                setTrainTaskInfo(device_info['task']);
                // 设置训练任务参数
                setTrainTaskArguments(device_info['train']);
            }
            reset_device_status_timeout = setTimeout(function () {
                connectionStatus.classList.remove('status-active');
                connectionStatus.classList.remove('status-training');
                connectionStatus.classList.add('status-idle');
            }, 60 * 1000);
        } catch (error) {
            console.error('处理设备信息时出错:', error);
        }
    }

    function onSyncModelReceived(message) {
        console.log(message);
        document.getElementById('custom-message').remove();
    }

</script>
<script data-logging-script="true">console.log("[MiniApp] body结束前");</script>
</body>
</html>
