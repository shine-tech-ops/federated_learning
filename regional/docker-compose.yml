services:
  mqtt:
    image: eclipse-mosquitto:2.0
    container_name: regional_mosquitto
    ports:
      - "1883:1883"
      - "18083:18083"
    volumes:
      - ../mosquitto.conf:/mosquitto/config/mosquitto.conf
      - ../mosquitto.passwd:/mosquitto/config/mosquitto.passwd
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
    restart: always
    networks:
      - regional

  regional:
    build:
      context: ..
      dockerfile: ./dockers/regional.Dockerfile
    container_name: regional_node
    volumes:
      - .:/code
    ports:
      - "8087:8080"
    environment:
      - MQTT_BROKER_HOST=mosquitto
      - MQTT_BROKER_PORT=1883
      - MQTT_USER=${MQTT_USER:-mqtt}
      - MQTT_PASSWORD=${MQTT_PASSWORD:-mqtt2024#}
      # RabbitMQ 配置 - 需要设置为 backend 机器的实际 IP 地址或主机名
      # 例如: RABBITMQ_HOST=192.168.1.100 或 RABBITMQ_HOST=backend.example.com
      - RABBITMQ_HOST=${RABBITMQ_HOST}
      - RABBITMQ_PORT=${RABBITMQ_PORT:-5672}
      - RABBITMQ_USER=${RABBITMQ_USER:-rabbitmq}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-rabbitmq}
      # 中央服务器配置
      - CENTRAL_SERVER_URL=${CENTRAL_SERVER_URL:-http://localhost:8000}
    depends_on:
      - mqtt
    restart: always
    networks:
      - regional
    command: python run.py

networks:
  regional:
    driver: bridge

