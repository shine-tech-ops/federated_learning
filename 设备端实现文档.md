# 联邦学习设备端实现文档

## 概述

本文档详细描述了联邦学习系统中设备端（Edge Device）的实现细节，包括MQTT监听、Flower接口实现和完整工作流程。

---

## 1. MQTT监听与动作处理

### 1.1 MQTT主题订阅

设备端监听以下MQTT主题：

#### 1.1.1 设备命令主题下·
```
federated_task_device_{device_id}/+
```

**说明**: 
- `{device_id}` 是具体的设备ID，如 `device_001`
- `+` 通配符表示监听该设备的所有子主题
- 实际订阅的主题示例：`federated_task_device_device_001/task_start`



### 1.2 MQTT消息处理动作

设备端根据接收到的MQTT消息中的 `action` 字段执行相应动作：

#### 1.2.1 任务开始 (`task_start`)

**触发条件**: 收到 `action: "task_start"` 的MQTT消息

**消息格式**:
```json
{
    "action": "task_start",
    "task_id": 1,
    "flower_server": {
        "host": "192.168.1.10",
        "port": 8080
    },
    "model_info": {
        "id": 1,
        "name": "MNIST模型"
    },
    "training_config": {
        "epochs": 10,
        "batch_size": 32,
        "learning_rate": 0.01
    }
}
```

**代码实现**:
```python
def _handle_task_start(self, message: dict):
    """处理任务开始"""
    logger.info(f"开始处理任务: {message['task_id']}")
    
    try:
        # 保存任务信息
        self.current_task = message
        
        # 获取 Flower 服务器信息
        flower_server = message.get('flower_server', {})
        if not flower_server:
            logger.error("缺少 Flower 服务器信息")
            return
        
        # 创建训练器
        self.trainer = MNISTTrainer(
            device_id=self.device_id,
            task_data=message
        )
        
        # 创建 Flower 客户端
        self.flower_client = FlowerClient(
            device_id=self.device_id,
            trainer=self.trainer,
            server_address=f"{flower_server['host']}:{flower_server['port']}"
        )
        
        # 在后台线程启动联邦学习
        fl_thread = threading.Thread(
            target=self._start_federated_learning,
            daemon=True
        )
        fl_thread.start()
        
        logger.info(f"设备 {self.device_id} 开始联邦学习")
        
    except Exception as e:
        logger.error(f"处理任务开始错误: {e}")
```

#

## 2. Flower接口实现

### 2.1 Flower客户端类

设备端实现了 `fl.client.NumPyClient` 接口，需要实现以下三个核心方法：

#### 2.1.1 `get_parameters(config)` - 获取模型参数

**功能**: 获取当前模型的参数

**参数**:
- `config`: 配置字典

**返回值**: `List[np.ndarray]` - 模型参数列表

**代码实现**:
```python
def get_parameters(self, config: Dict[str, Any]) -> List[np.ndarray]:
    """获取模型参数"""
    logger.info(f"设备 {self.device_id} 获取模型参数")
    return self.trainer.get_parameters()
```

#### 2.1.2 `fit(parameters, config)` - 训练模型

**功能**: 使用接收到的全局模型参数进行本地训练

**参数**:
- `parameters`: 全局模型参数
- `config`: 训练配置

**返回值**: `Tuple[List[np.ndarray], int, Dict[str, Any]]`
- 更新后的模型参数
- 训练样本数量
- 训练指标

**代码实现**:
```python
def fit(self, parameters: List[np.ndarray], config: Dict[str, Any]) -> Tuple[List[np.ndarray], int, Dict[str, Any]]:
    """训练模型"""
    logger.info(f"设备 {self.device_id} 开始训练")
    
    # 执行训练
    updated_parameters, num_examples, metrics = self.trainer.fit(parameters, config)
    
    # 记录训练结果
    logger.info(f"设备 {self.device_id} 训练完成: {metrics}")
    
    return updated_parameters, num_examples, metrics
```

#### 2.1.3 `evaluate(parameters, config)` - 评估模型

**功能**: 使用接收到的模型参数进行本地评估

**参数**:
- `parameters`: 模型参数
- `config`: 评估配置

**返回值**: `Tuple[float, int, Dict[str, Any]]`
- 损失值
- 评估样本数量
- 评估指标

**代码实现**:
```python
def evaluate(self, parameters: List[np.ndarray], config: Dict[str, Any]) -> Tuple[float, int, Dict[str, Any]]:
    """评估模型"""
    logger.info(f"设备 {self.device_id} 开始评估")
    
    # 执行评估
    loss, num_examples, metrics = self.trainer.evaluate(parameters, config)
    
    # 记录评估结果
    logger.info(f"设备 {self.device_id} 评估完成: {metrics}")
    
    return loss, num_examples, metrics
```

### 2.2 Flower客户端控制方法

#### 2.2.1 `start()` - 启动客户端

**功能**: 连接到Flower服务器并开始联邦学习

**代码实现**:
```python
def start(self):
    """启动 Flower 客户端"""
    try:
        logger.info(f"设备 {self.device_id} 连接到 Flower 服务器: {self.server_address}")
        
        # 启动 Flower 客户端
        fl.client.start_numpy_client(
            server_address=self.server_address,
            client=self
        )
        
        self.running = True
        logger.info(f"设备 {self.device_id} Flower 客户端已启动")
        
    except Exception as e:
        logger.error(f"启动 Flower 客户端失败: {e}")
        raise
```


## 3. 完整工作流程

**详细步骤**:

1. **任务接收**:
   - 通过MQTT接收 `task_start` 消息
   - 解析任务配置和Flower服务器信息

2. **组件初始化**:
   - 创建 `MNISTTrainer` 训练器
   - 创建 `FlowerClient` 客户端
   - 在后台线程启动联邦学习

3. **联邦学习循环**:
   - 连接到Flower服务器
   - 等待服务器调用 `get_parameters`、`fit`、`evaluate` 方法
   - 执行相应的本地操作并返回结果
